# 产品设计文档：日元记账应用

## 1. 设计目标与原则
- 聚焦日元个人记账，提供快速录入、清晰 dashboard、多维统计，促进稳定、诚实的记账习惯。
- 体验原则：极简、TUI 风格、主要动作可单手完成；跨端同步无感，冲突可控透明。
- 技术原则：本地优先（离线可用）、同步可追溯（rev/device_id）、数据模型围绕“主标签 + 副标签”与月度预算。

## 2. 平台与架构概览
- 客户端：iOS（主要录入）、macOS（录入/编辑/查看）。统一 UI 语言与组件。
- 后端：Supabase（Postgres + Auth），使用 RLS 保护 user_id 作用域。
- 本地存储：SQLite（推荐 GRDB）或 Core Data，缓存全量业务表与变更队列；支持软删除。
- 同步层：本地变更队列（按时间顺序），定时/事件触发同步；冲突检测基于 rev/version 和 device_id。
- 可视化与统计：客户端本地按月聚合；必要时持久化月度缓存表减少图表计算。

## 3. 数据模型要点（承接 PRD）
- 核心表：categories、tags、locations、entries、entry_tags、budgets、budget_rollovers、fixed_expense_templates、fixed_expense_runs。
- 约束与索引：categories/tags/locations 用户维度唯一；budgets 唯一 (user_id, month, tag_id)；entries 索引 (user_id, occurred_on)；entry_tags 复合主键 (entry_id, tag_id, role)。
- 字段与规则：currency 固定 JPY；amount 整数到个位；is_fixed 标记固定开销；tag_type/role 区分主/副。
- 软删除：deleted_at；rev/device_id/updated_at 供同步与冲突对比。

## 4. 配置与开关
- 充值计支出模式：默认“充值视为转账”；设置页开关为“充值即计支出”。还款始终为转账。
- 预算结余结转：默认开启；设置页提供开关，控制是否将上月结余计入下月总预算。

## 5. 关键业务流程
### 5.1 首次启动/初始化
- 登录（Supabase Auth 邮箱/Apple）。
- 拉取或创建默认分类/标签/预算；可选择启用默认固定开销模板。

### 5.2 快速记账
- 输入金额（数字键盘、光标默认在金额）→ 选择主标签（必选、唯一）→ 副标签（多选可空）→ 地点/备注（可选）→ 保存。
- 保存时生成 entries 与 entry_tags；主标签冗余校验 main_tag_id；副标签按 role=secondary。
- 金额精确到个位，千分位展示；货币符号日元。

### 5.3 固定开销
- 模板：金额、主标签、执行日(1–28)、active 状态。
- 生成逻辑：每月初在客户端定时任务检查 runs（fixed_expense_runs）是否已生成；若无则创建 entry + run(status=created/posted)。生成的 entries 标记 is_fixed=true。
- UI：列表/图表淡色显示，无单独视图；可在模板管理启用/停用或编辑。

### 5.4 预算管理
- 空白月份：自动复制上月预算草稿，可编辑。
- 锁定：当月出现任一 entry 即锁定 budgets.locked；锁定后仅查看。
- 预警：>80% 黄/橙，>100% 红；超支分类在列表/图表中红色标示。
- 结转：若开关开启，上一月结余记录到 budget_rollovers 并计入下月总预算。

### 5.5 转账规则
- 默认：信用卡→交通 IC 充值为转账（不计支出）；乘车/消费时记支出。
- 开关开启时：充值即计支出；还款仍为转账，避免重复。
- 所有充值/还款均存为转账记录；支出以实际消费为准。

### 5.6 Dashboard 与统计
- 默认当月，可左右滑或顶部选择器切换历史月。
- 模块：1) 当月支出与结余/超支（区分固定/非固定）；2) 分类预算进度；3) 分类占比；4) 每日支出折线；5) 分类按月趋势；6) 活跃度 heat map；显示固定开销总额。
- 视觉：副标签同色系 30–40% 透明度；固定开销主色 20% 或浅灰；图例标注副标签/固定开销含义。
- 数据来源：本地按月聚合 entries + entry_tags；预算进度结合 budgets/budget_rollovers；热力图按 occurred_on 计数/金额。

### 5.7 列表与详情
- 列表：按日期倒序，固定开销淡色；超支分类用红色；支持软删除。
- 详情：展示主/副标签图例、金额、日期、地点、备注；可编辑保存或软删除。

### 5.8 导出与设置
- 设置页：提供 CSV 导出入口（按年选择，导出所有字段），提供“预算结转”与“充值即计支出”开关。
- 导出字段：entries 全字段 + 主/副标签展开 + 地点 + is_fixed + 预算/结转关联信息（如需可带预算月）。

## 6. 同步与离线设计
- 本地变更队列：记录 CRUD 与软删除操作，含 rev/device_id。离线可写入队列。
- 同步触发：登录后、前台唤醒、手动刷新、定时（如每 24h）。
- 冲突处理：上传检测 server rev 变化且字段差异 → 拉取远端版本，与本地对比 → UI 左右对比，用户选“保留本地”或“接受远端”整条覆盖 → 提示可继续编辑，操作不可撤销。
- 软删除：deleted_at 上传后保留，避免被覆盖。
- 自动重试：网络失败后每 24h 后台重试，无前端提示。

## 7. 安全与权限
- 认证：Supabase Auth（邮箱/Apple）。
- 授权：RLS 限定 user_id，客户端仅持访问自身数据的 token。
- 隐私：无额外本地加密需求；遵守最小权限，缓存限于业务表与队列。

## 8. UI 与视觉规范
- 风格：极简 TUI，等宽字体；卡片无阴影，1px 边框，小圆角 4px；主按钮实心，次按钮描边。
- 色板：背景 #F9FAFB，文字 #1F2933，分隔线/边框 #E5E7EB，强调色单一冷色（#0EA5E9 或 #22D3EE）；预算预警黄/橙，超支红，固定开销浅灰或主色 20% 透明度，副标签 30–40% 透明度。
- 图表：线宽 2px，必须有图例标注副标签/固定开销；货币展示日元符号 + 千分位，无小数。

## 9. 性能与技术考量
- 聚合缓存：可在本地维护按月聚合缓存，减少大表扫描；变更时增量更新。
- 数据一致性：主标签冗余 main_tag_id 与 entry_tags 校验；上传前校验唯一约束（categories/tags/locations）。
- 固定开销幂等：fixed_expense_runs 作为生成记录，防止重复入账；生成失败可重试。

## 10. 可扩展性与迭代思路
- 预留 tag/category sort_index 与唯一约束，支持后续排序/重命名。
- 导出格式如需调整可在设置页增加字段选择；预算结转和充值模式为开关，便于后续 A/B。
- 当前不计划实体账户与账单日，后续如需引入需新增账户维度与转账校验。
