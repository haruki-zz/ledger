# 产品需求文档：日元记账应用

## 1. 背景与目标
- 目标：打造以日元为主的个人记账应用，突出美观且信息丰富的 dashboard 与多样统计，帮助用户养成稳定、诚实的记账习惯。
- 价值主张：通过清晰的收支反馈、预算预警与活跃度可视化，提升用户的记账动力与透明度。
- 平台范围：iOS 为主要录入端，macOS 支持录入、编辑与查看；需跨端数据同步。短期不做 Android/Web。
- 数据来源：仅手动输入，暂无自动拉取。

## 2. 目标用户与场景
- 个人理财用户，主要在日本使用日元记账。
- 场景：每日快速记账、查看当月支出与预算进度、了解类别/标签占比、复盘历史月份。
- 习惯培养：依赖 dashboard 视觉反馈与活跃度 heat map，暂不提供额外提醒。

## 3. 范围与假设
- 在范围：手动记账、多标签（主/副）、月度预算管理、固定开销自动生成、转账区分、跨端同步、冲突合并、CSV 导出。
- 不在范围：搜索/筛选功能、色盲友好设计、自动备份（仅手动 CSV 导出）、Android/Web 客户端、实体账户管理（仅记录用户输入）、entries/budgets 的附件/照片/地理位置/预算备注字段。
- 假设：用户接受 Supabase 账号体系（邮箱/Apple 登录），无额外本地加密要求；可使用日元为主币种，未来可能加人民币但不做汇率换算。

## 4. 成功标准（定性）
- 用户能在 iOS/macOS 流畅完成“快速记一笔”且同步无感。
- Dashboard 清晰呈现当月支出、预算预警与活跃度，帮助用户理解支出结构。
- 冲突处理透明可控，用户能明确选择保留本地或远端数据。

## 5. 功能需求
### 5.1 记账与多标签
- 每笔仅一个主标签，可选多个副标签；总支出只计一次。
- 副标签参与统计与预算，但以淡化视觉标识；主标签作为主要归类与占比依据。
- 支持金额、发生日期、地点、备注输入；货币默认 JPY，金额精确到个位（无小数），千分位分隔。

### 5.2 预算管理
- 月度维度为每个标签设置预算（主/副均可设）；默认稳定可修改。
- 空白月份自动复制上月预算；一旦当月出现记账即锁定预算，锁定后仅可查看。
- 超支与预警：>80% 预算用黄/橙预警，>100% 用红色；超支分类在列表/图表中以红色标示。
- 预算结余全额结转到下月总预算，通过 budget_rollovers 记录；结转默认开启，提供开关（设置页）供用户自行选择是否结转。

### 5.3 固定开销
- 提供固定开销模板（金额、标签、每月日、启用状态）；每月初自动生成对应的记账记录并标记为固定开销。
- 固定开销在列表与图表中以淡色展示，无单独视图。

### 5.4 转账与账户规则
- 区分消费 vs 转账：信用卡给交通 IC 充值默认视为转账（信用卡负债增加、IC 余额增加），不计支出；实际消费时记支出。
- 提供配置切换为“充值即计支出”；无论模式如何，信用卡还款始终作为转账处理，不重复计支出。
- 充值/还款记录均为转账；支出在消费发生时计入。

### 5.5 Dashboard 与统计
- 默认展示当月，可切换历史月份（顶部选择器 + 左右滑动）。
- 模块优先级：1) 当月支出与结余/超支（突出非固定并区分固定）；2) 各分类预算进度；3) 分类占比；4) 每日支出折线；5) 各分类按月趋势；6) 活跃度 heat map；展示固定开销总额。
- 可视化：折线图、柱状图、扇形图、进度条；副标签同色系淡化，固定开销用浅灰或主色 20% 透明度。
- 图例需标明副标签与固定开销含义。

### 5.6 记录管理
- 支持新增、编辑、删除（软删除）记录；修改后预算与统计实时更新。
- 记录详情需展示主/副标签图例说明，帮助理解统计方式。

### 5.7 同步、离线与冲突
- 数据存储：使用 Supabase。
- 离线可编辑，操作入本地变更队列；联网后按时间顺序同步。
- 冲突检测：基于 rev/version 和 device_id；发现冲突时展示差异，对整条记录选择“保留本地覆盖”或“接受远端覆盖”；合并后不可撤销但可再编辑。
- 同步失败（网络）后台每 24h 自动重试，前端不提示。

### 5.8 导出
- 支持手动导出 CSV（以年为单位的时间范围，导出所有字段）；无自动备份。入口放在设置页。

## 6. 用户流程
- 首次上手：注册/登录 → 载入默认分类/标签/预算 → 选择是否启用固定开销模板。
- 快速记一笔：打开输入页 → 金额输入（数字键盘，光标默认在金额）→ 选主/副标签 → 选地点/备注（可选）→ 保存。
- 编辑/删除：在列表或详情修改金额/标签/备注，或软删除；同步后预算/统计自动更新。
- 预算设置：空白月份默认复制上月 → 可编辑 → 当月有记账后自动锁定。
- 固定开销：配置模板 → 每月初自动生成 → 在列表中淡色显示，可编辑。
- 冲突合并：检测冲突 → 展示左右对比 → 选择一侧覆盖 → 提示已合并，可继续编辑。
- 导出：在设置或工具入口选择时间范围 → 导出 CSV。

## 7. 数据模型（Supabase 草案）
- categories：用户维度唯一 name，含 is_fixed、sort_index、软删除与同步字段。
- tags：用户维度唯一 name，tag_type（primary/secondary）、sort_index、同步字段。
- locations：用户维度唯一 name，带同步字段。
- entries：金额、currency=JPY、occurred_on、note、location_id、main_tag_id（冗余校验）、is_fixed，含 rev/version 等同步字段。
- entry_tags：entry_id + tag_id + role(primary/secondary) 复合主键，支持多副标签。
- budgets：month(YYYY-MM) + tag_id 唯一；金额、locked 标记、同步字段。
- budget_rollovers：month、source_month、amount 记录结余结转。
- fixed_expense_templates：name、amount、tag_id、day_of_month(1–28)、active，含同步字段。
- fixed_expense_runs：template_id + month + entry_id + status(created/posted)。
- 索引与约束：categories/tags/locations 唯一约束；entries 按 user_id+occurred_on 建索引；预算唯一约束 (user_id, month, tag_id)。

## 8. 业务规则与计算
- 多标签统计：总支出只计一次；主标签正常计入；副标签在统计与预算中计入并以淡化视觉区分。
- 预算与结余：当月预算锁定后不可改；结余通过 budget_rollovers 全额计入下月总预算；超支分类用红色标示。
- 固定开销：每月初生成 entries 并标记 is_fixed=true；计入总支出，在图表中淡化显示。
- 活跃度 heat map：按 entries.occurred_on 的记账次数/金额映射日历格。
- 时间范围：Dashboard 默认当前月，可浏览历史月。

## 9. 交互与视觉规范
- 设计基调：极简、TUI 风格；使用等宽字体；无多余装饰。
- 色板建议：浅色背景 (#F9FAFB)、深灰文字 (#1F2933)、分隔线/边框 (#E5E7EB)、强调色单一冷色（如 #0EA5E9 或 #22D3EE）；预算预警黄/橙，超支红，固定开销浅灰或主色 20% 透明度，副标签用主色 30–40% 透明度。
- 组件：卡片无阴影，1px 边框，小圆角 4px；按钮扁平，主色填充，次按钮描边；禁用态降透明度。
- 图表：线宽 2px；副标签、固定开销按淡化规则；必须有图例标注副标签与固定开销。
- 列表：固定开销用淡色标记；预算预警颜色与进度条一致。

## 10. 同步与容错流程
- 本地缓存全量表数据，记录 rev/version 和 device_id。
- 变更队列支持离线操作；联网后顺序上传。
- 冲突检测依据服务器 rev 更新；若发现字段差异，弹出对比并要求选择一侧覆盖。
- 软删除：deleted_at 标记，按 rev 同步，避免删除被覆盖。

## 11. 安全与登录
- 使用 Supabase Auth（邮箱/Apple 登录）；暂无额外本地加密或隐私增强需求。

## 12. 风险与待确认
- 暂无高优先级待确认项；如后续需求变化（例如导出字段或结转开关展示），需同步调整。
